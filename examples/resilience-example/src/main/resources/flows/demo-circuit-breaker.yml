flow:
  id: 'demo-circuit-breaker'
  description: 'Demonstrate circuit breaker usage'
  ttl: 10s
  exception: 'v1.hello.exception'

first.task: 'resilience.handler'

tasks:
  - name: 'my.task'
    input:
      - 'model.attempt -> attempt'
      - 'input.query.mode -> mode'
    process: 'v1.process.data'
    output:
      - 'int(204) -> output.status'
      - 'int(0) -> model.attempt'
      - 'model.none -> file(/tmp/resilience/backoff)'
      - 'model.none -> file(/tmp/resilience/cumulative)'
    description: 'Inform the user that a profile will be created'
    execution: end
    exception: 'resilience.handler'

  - input:
      - 'error.code -> status'
      - 'error.message -> message'
      - 'model.attempt -> attempt'
      - 'int(2) -> max_attempts'
      - 'text(401, 403-404) -> alternative'
      - 'file(text:/tmp/resilience/cumulative) -> cumulative'
      - 'file(text:/tmp/resilience/backoff) -> backoff'
      - 'int(10) -> backoff_trigger'
      - 'int(60) -> backoff_seconds'
      - 'int(500) -> delay'
    process: 'resilience.handler'
    output:
      - 'result.status -> model.status'
      - 'result.message -> model.message'
      - 'result.attempt -> model.attempt'
      - 'result.decision -> decision'
      - 'result.backoff -> file(/tmp/resilience/backoff)'
      - 'result.cumulative -> file(/tmp/resilience/cumulative)'
    description: 'Resilience handler with alternative path and backoff features'
    execution: decision
    next:
      - 'my.task'
      - 'abort.request'
      - 'alternative.task'

  - name: 'abort.request'
    input: []
    process: 'no.op'
    output:
      - 'text(application/json) -> output.header.content-type'
      - 'result.status -> output.status'
      - 'text(Abort function kicks in after 3 retries or when backoff is active) -> output.body.result'
    description: 'This function aborts a request'
    execution: end


  - name: 'alternative.task'
    input:
      - 'text(alternative) -> path'
    process: 'no.op'
    output:
      # Reset number of attempt, backoff and cumulative if any
      - 'int(0) -> model.attempt'
      - 'model.none -> file(/tmp/resilience/backoff)'
      - 'model.none -> file(/tmp/resilience/cumulative)'
      - 'text(application/json) -> output.header.content-type'
      - 'text(recovered from failure) -> output.body.result'
    description: 'This function will just return ok'
    execution: end

  - input:
      - 'error.code -> status'
      - 'error.message -> message'
      - 'error.stack -> stack'
    process: 'v1.hello.exception'
    output:
      - 'result.status -> output.status'
      - 'result -> output.body'
    description: 'Just a demo exception handler'
    execution: end
